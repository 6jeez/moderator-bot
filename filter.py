from aiogram import Bot, Dispatcher, executor, types
from aiogram.utils.markdown import hlink
import datetime
import sqlite3
import time
from threading import Thread


token = ''


base = sqlite3.connect('posts.db', check_same_thread=False)
cur = base.cursor()

base.execute('CREATE TABLE IF NOT EXISTS {}(id PRIMARY KEY, number_message)'.format('data'))
base.commit()

bot = Bot(token = token)
dp = Dispatcher(bot)

admins = [1226004359]
spam = ['6ля','6лядь','6лять','b3ъeб','cock','cunt','e6aль','ebal','eblan','eбaл','eбaть','eбyч','eбать','eбёт','eблантий','fuck','fucker','fucking','xyёв','xyй','xyя','xуеxуй','xую','zaeb','zaebal','zaebali','zaebat','архипиздрит','ахуел','ахуеть','бздение','бздеть','бздех','бздецы','бздит','бздицы','бздло','бзднуть','бздун','бздунья','бздюха','бздюшка','бздюшко','бля','блябу','блябуду','бляд','бляди','блядина','блядище','блядки','блядовать','блядство','блядун','блядуны','блядунья','блядь','блядюга','блять','вафел','вафлёр','взъебка','взьебка','взьебывать','въеб','въебался','въебенн','въебусь','въебывать','выблядок','выблядыш','выеб','выебать','выебен','выебнулся','выебон','выебываться','выпердеть','высраться','выссаться','вьебен','гавно','гавнюк','гавнючка','гамно','гандон','гнид','гнида','гниды','говенка','говенный','говешка','говназия','говнецо','говнище','говно','говноед','говнолинк','говночист','говнюк','говнюха','говнядина','говняк','говняный','говнять','гондон','доебываться','долбоеб','долбоёб','долбоящер','дрисня','дрист','дристануть','дристать','дристун','дристуха','дрочелло','дрочена','дрочила','дрочилка','дрочистый','дрочить','дрочка','дрочун','е6ал','е6ут','еб','твою','мать','ёб','твою','мать','ёбaн','ебaть','ебyч','ебал','ебало','ебальник','ебан','ебанамать','ебанат','ебаная','ёбаная','ебанический','ебанный','ебанныйврот','ебаное','ебануть','ебануться','ёбаную','ебаный','ебанько','ебарь','ебат','ёбат','ебатория','ебать','ебать-копать','ебаться','ебашить','ебёна','ебет','ебёт','ебец','ебик','ебин','ебись','ебическая','ебки','ебла','еблан','ебливый','еблище','ебло','еблыст','ебля','ёбн','ебнуть','ебнуться','ебня','ебошить','ебская','ебский','ебтвоюмать','ебун','ебут','ебуч','ебуче','ебучее','ебучий','ебучим','ебущ','ебырь','елда','елдак','елдачить','жопа','жопу','заговнять','задрачивать','задристать','задрота','зае6','заё6','заеб','заёб','заеба','заебал','заебанец','заебастая','заебастый','заебать','заебаться','заебашить','заебистое','заёбистое','заебистые','заёбистые','заебистый','заёбистый','заебись','заебошить','заебываться','залуп','залупа','залупаться','залупить','залупиться','замудохаться','запиздячить','засерать','засерун','засеря','засирать','засрун','захуячить','заябестая','злоеб','злоебучая','злоебучее','злоебучий','ибанамат','ибонех','изговнять','изговняться','изъебнуться','ипать','ипаться','ипаццо','Какдвапальцаобоссать','конча','курва','курвятник','лох','лошарa','лошара','лошары','лошок','лярва','малафья','манда','мандавошек','мандавошка','мандавошки','мандей','мандень','мандеть','мандища','мандой','манду','мандюк','минет','минетчик','минетчица','млять','мокрощелка','мокрощёлка','мразь','мудak','мудaк','мудаг','мудак','муде','мудель','мудеть','муди','мудил','мудила','мудистый','мудня','мудоеб','мудозвон','мудоклюй','нахер','нахуй','набздел','набздеть','наговнять','надристать','надрочить','наебать','наебет','наебнуть','наебнуться','наебывать','напиздел','напиздели','напиздело','напиздили','насрать','настопиздить','нахер','нахрен','нахуй','нахуйник','не','ебет','не','ебёт','невротебучий','невъебенно','нехира','нехрен','Нехуй','нехуйственно','ниибацо','ниипацца','ниипаццо','ниипет','никуя','нихера','нихуя','обдристаться','обосранец','обосрать','обосцать','обосцаться','обсирать','объебос','обьебать','обьебос','однохуйственно','опездал','опизде','опизденивающе','остоебенить','остопиздеть','отмудохать','отпиздить','отпиздячить','отпороть','отъебись','охуевательский','охуевать','охуевающий','охуел','охуенно','охуеньчик','охуеть','охуительно','охуительный','охуяньчик','охуячивать','охуячить','очкун','падла','падонки','падонок','паскуда','педерас','педик','педрик','педрила','педрилло','педрило','педрилы','пездень','пездит','пездишь','пездо','пездят','пердануть','пердеж','пердение','пердеть','пердильник','перднуть','пёрднуть','пердун','пердунец','пердунина','пердунья','пердуха','пердь','переёбок','пернуть','пёрнуть','пи3д','пи3де','пи3ду','пиzдец','пидар','пидарaс','пидарас','пидарасы','пидары','пидор','пидорасы','пидорка','пидорок','пидоры','пидрас','пизда','пиздануть','пиздануться','пиздарваньчик','пиздато','пиздатое','пиздатый','пизденка','пизденыш','пиздёныш','пиздеть','пиздец','пиздит','пиздить','пиздиться','пиздишь','пиздища','пиздище','пиздобол','пиздоболы','пиздобратия','пиздоватая','пиздоватый','пиздолиз','пиздонутые','пиздорванец','пиздорванка','пиздострадатель','пизду','пиздуй','пиздун','пиздунья','пизды','пиздюга','пиздюк','пиздюлина','пиздюля','пиздят','пиздячить','писбшки','писька','писькострадатель','писюн','писюшка','похуй','похую','подговнять','подонки','подонок','подъебнуть','подъебнуться','поебать','поебень','поёбываает','поскуда','посрать','потаскуха','потаскушка','похер','похерил','похерила','похерили','похеру','похрен','похрену','похуй','похуист','похуистка','похую','придурок','приебаться','припиздень','припизднутый','припиздюлина','пробзделся','проблядь','проеб','проебанка','проебать','промандеть','промудеть','пропизделся','пропиздеть','пропиздячить','раздолбай','разхуячить','разъеб','разъеба','разъебай','разъебать','распиздай','распиздеться','распиздяй','распиздяйство','распроеть','сволота','сволочь','сговнять','секель','серун','серька','сестроеб','сикель','сила','сирать','сирывать','соси','спиздел','спиздеть','спиздил','спиздила','спиздили','спиздит','спиздить','срака','сраку','сраный','сранье','срать','срун','ссака','ссышь','стерва','страхопиздище','сука','суки','суходрочка','сучара','сучий','сучка','сучко','сучонок','сучье','сцание','сцать','сцука','сцуки','сцуконах','сцуль','сцыха','сцышь','съебаться','сыкун','трахае6','трахаеб','трахаёб','трахатель','ублюдок','уебать','уёбища','уебище','уёбище','уебищное','уёбищное','уебк','уебки','уёбки','уебок','уёбок','урюк','усраться','ушлепок','х_у_я_р_а','хyё','хyй','хyйня','хамло','хер','херня','херовато','херовина','херовый','хитровыебанный','хитрожопый','хуeм','хуе','хуё','хуевато','хуёвенький','хуевина','хуево','хуевый','хуёвый','хуек','хуёк','хуел','хуем','хуенч','хуеныш','хуенький','хуеплет','хуеплёт','хуепромышленник','хуерик','хуерыло','хуесос','хуесоска','хуета','хуетень','хуею','хуи','хуй','хуйком','хуйло','хуйня','хуйрик','хуище','хуля','хую','хуюл','хуя','хуяк','хуякать','хуякнуть','хуяра','хуясе','хуячить','целка','чмо','чмошник','чмырь','шалава','шалавой','шараёбиться','шлюха','шлюхой','шлюшка','ябывает']

links = ['https://', 'http://']


class BackgroundTimer(Thread):   
    def run(self):
        while True:
            
            dt = datetime.datetime.now()
            time2 = str(dt)
            time1 = time2[11:16]
            if time1 != '00:00':
                pass
                
            else:
                cur.execute('DELETE FROM data')
                base.commit()
                
                print('Таблица очищена')
                time.sleep(60)
                

@dp.message_handler(content_types=types.ContentTypes.ANY)
async def filter(message: types.message):

    try:
        print(message)
        us = message.from_user.first_name
        use = message.from_user.username
        idd = message.from_user.id
        name = message.from_user.first_name

        buttons = [
            types.InlineKeyboardButton(text = '🔳 RULES 🔳', url = ''),
        ]

        keyboard = types.InlineKeyboardMarkup(row_width=2)
        keyboard.add(*buttons)

        words = spam
        try:
            sim = len(message.text)
        except:
            sim = len(message.caption)

        fil = int(sim)

        try:
            phrase = message.text.lower()
        except:
            phrase = message.caption.lower()

        def distance(a, b): 
            n, m = len(a), len(b)
            if n > m:
            
                a, b = b, a
                n, m = m, n

            current_row = range(n + 1)
            for i in range(1, m + 1):
                previous_row, current_row = current_row, [i] + [0] * n
                for j in range(1, n + 1):
                    add, delete, change = previous_row[j] + 1, current_row[j - 1] + 1, previous_row[j - 1]
                    if a[j - 1] != b[i - 1]:
                        change += 1
                    current_row[j] = min(add, delete, change)

            return current_row[n]

        d =   {'а' : ['а', 'a', '@'],
        'б' : ['б', '6', 'b'],
        'в' : ['в', 'b', 'v'],
        'г' : ['г', 'r', 'g'],
        'д' : ['д', 'd'],
        'е' : ['е', 'e'],
        'ё' : ['ё', 'e'],
        'ж' : ['ж', 'zh', '*'],
        'з' : ['з', '3', 'z'],
        'й' : ['й', 'u', 'i', 'y'],
        'к' : ['к', 'k', 'i{', '|{'],
        'л' : ['л', 'l', 'ji'],
        'м' : ['м', 'm'],
        'н' : ['н', 'h', 'n'],
        'о' : ['о', 'o', '0'],
        'п' : ['п', 'n', 'p'],
        'р' : ['р', 'r', 'p'],
        'с' : ['с', 'c', 's'],
        'т' : ['т', 'm', 't'],
        'у' : ['у', 'y', 'u'],
        'ф' : ['ф', 'f'],
        'х' : ['х', 'x', 'h' , '}{'],
        'ц' : ['ц', 'c', 'u,'],
        'ч' : ['ч', 'ch'],
        'ш' : ['ш', 'sh'],
        'щ' : ['щ', 'sch'],
        'ь' : ['ь', 'b'],
        'ы' : ['ы', 'bi'],
        'ъ' : ['ъ'],
        'э' : ['э', 'e'],
        'ю' : ['ю', 'io'],
        'я' : ['я', 'ya']
        }

        for key, value in d.items():
            for letter in value:
                for phr in phrase:
                    if letter == phr:
                        phrase = phrase.replace(phr, key)

        for word in words:
            for part in range(len(phrase)):
                fragment = phrase[part: part+len(word)]
                if distance(fragment, word) <= len(word)*0.15:
                    if len(word) >= 3:
                        await message.delete()
                        await message.answer(f'<a href="tg:user?id={idd}">{name}</a>, использование мата запрещено.', reply_markup = keyboard, parse_mode = 'HTML')
                elif fil > 1000:
                    await message.delete()
                    await message.answer(f'<a href="tg:user?id={idd}">{name}</a>, максимально допустимое количество - 1000', reply_markup = keyboard, parse_mode = 'HTML')

                
                for i in links:
                    try:
                        if i in message.text:
                            if 'https://t.me' in message.text:
                                pass
                            else:
                                await message.delete()
                                await message.answer(f'<a href="tg:user?id={idd}">{name}</a>, использование ссылок запрещено.', reply_markup = keyboard, parse_mode = 'HTML')
                        else:
                            pass
                    except:
                        if i in message.caption:
                            if 'https://t.me' in message.caption:
                                pass
                            else:
                                await message.delete()
                                await message.answer(f'<a href="tg:user?id={idd}">{name}</a>, использование ссылок запрещено.', reply_markup = keyboard, parse_mode = 'HTML')
                        else:
                            pass
        for admin in admins:
            if admin == message.from_user.id:
                return
        try:
            cur.execute('INSERT INTO data VALUES(?, ?)', (f'{idd}', '1'))
            base.commit()
        except:
            r = cur.execute('SELECT number_message FROM data WHERE id == ?', (f'{idd}',)).fetchone()
            base.commit()			
            text = str(r)
            zap = text.replace(',', ':')
            scob = zap.replace('(', '')
            scob2 = scob.replace(')', '')
            verh = scob2.replace("'", '')
            kon = verh.replace(' ', '')
            kon2 = kon.replace(':', '')
            print(kon2)
            kilvo = int(kon2)
            if kilvo == 3:
                await message.delete()
                await message.answer(f'<a href="tg:user?id={idd}">{name}</a>, максимальное количество сообщений в день - 3\n', reply_markup = keyboard, parse_mode = 'HTML')
            else:
                too = kilvo + 1
                too1 = str(too)
                print(too1)
                cur.execute('UPDATE data SET number_message == ? WHERE id == ?', (f'{too1}', f'{idd}'))
                base.commit()
    except Exception as err:
        print(err)
        pass


if __name__ == '__main__': 
    timer = BackgroundTimer()
    timer.start()
    executor.start_polling(dp, skip_updates=True)
